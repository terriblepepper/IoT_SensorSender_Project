<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>传感器数据仪表板</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <h1>传感器数据仪表板</h1>

        <!-- 按钮区 -->
        <div class="controls">
            <button id="pauseResumeBtn">暂停实时更新</button>
            <button id="exportDataBtn">导出数据</button>
        </div>

        <!-- 光强图 -->
        <h2>光强数据 (单位: lx)</h2>
        <canvas id="lightChart"></canvas>

        <!-- 加速度图 -->
        <h2>加速度传感器数据 (单位: m/s²)</h2>
        <canvas id="accelerometerChart"></canvas>

        <!-- 陀螺仪图 -->
        <h2>陀螺仪数据 (单位: °/s)</h2>
        <canvas id="gyroscopeChart"></canvas>

        <!-- 地图 -->
        <h2>地理位置地图</h2>
        <div id="map"></div>
    </div>

    <script>
        // 初始化变量
        const socket = io();
        let isPaused = false; // 实时更新状态
        const dataHistory = []; // 存储数据历史记录

        // 图表配置
        const lightChart = new Chart(document.getElementById("lightChart"), {
            type: "line",
            data: {
                labels: [],
                datasets: [{
                    label: "光强 (lx)",
                    data: [],
                    borderColor: "rgb(255, 99, 132)",
                    fill: false,
                }]
            },
            options: { responsive: true }
        });

        const accelerometerChart = new Chart(document.getElementById("accelerometerChart"), {
            type: "line",
            data: {
                labels: [],
                datasets: [
                    { label: "X轴加速度", data: [], borderColor: "rgb(75, 192, 192)", fill: false },
                    { label: "Y轴加速度", data: [], borderColor: "rgb(54, 162, 235)", fill: false },
                    { label: "Z轴加速度", data: [], borderColor: "rgb(153, 102, 255)", fill: false },
                ]
            },
            options: { responsive: true }
        });

        const gyroscopeChart = new Chart(document.getElementById("gyroscopeChart"), {
            type: "line",
            data: {
                labels: [],
                datasets: [
                    { label: "X轴角速度", data: [], borderColor: "rgb(255, 206, 86)", fill: false },
                    { label: "Y轴角速度", data: [], borderColor: "rgb(255, 159, 64)", fill: false },
                    { label: "Z轴角速度", data: [], borderColor: "rgb(201, 203, 207)", fill: false },
                ]
            },
            options: { responsive: true }
        });

        // 地图配置
        const map = L.map("map").setView([30.0, 120.0], 10); // 默认中心坐标
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        const pathLayer = L.polyline([], { color: "blue" }).addTo(map); // 路径层
        const geoFence = L.circle([30.0, 120.0], { radius: 1000, color: "red" }).addTo(map); // 地理围栏

        // 实时数据更新处理
        socket.on("update", (data) => {
            if (isPaused) return; // 如果暂停，则不更新

            // 更新图表
            const timestamp = data.Timestamp;
            if (data.Light) {
                lightChart.data.labels.push(timestamp);
                lightChart.data.datasets[0].data.push(data.Light);
                lightChart.update();
            }
            if (data.Accelerometer) {
                accelerometerChart.data.labels.push(timestamp);
                accelerometerChart.data.datasets.forEach((dataset, i) => {
                    dataset.data.push(data.Accelerometer[i]);
                });
                accelerometerChart.update();
            }
            if (data.Gyroscope) {
                gyroscopeChart.data.labels.push(timestamp);
                gyroscopeChart.data.datasets.forEach((dataset, i) => {
                    dataset.data.push(data.Gyroscope[i]);
                });
                gyroscopeChart.update();
            }

            // 更新地图
            if (data.Location) {
                const [longitude, latitude] = data.Location;
                const latLng = [latitude, longitude];
                pathLayer.addLatLng(latLng);
                map.setView(latLng, map.getZoom());
            }

            // 保存历史数据
            dataHistory.push(data);
        });

        // 暂停/恢复实时更新
        document.getElementById("pauseResumeBtn").addEventListener("click", () => {
            isPaused = !isPaused;
            document.getElementById("pauseResumeBtn").innerText = isPaused ? "恢复实时更新" : "暂停实时更新";
        });

        // 导出数据
        document.getElementById("exportDataBtn").addEventListener("click", () => {
            const csvContent = "data:text/csv;charset=utf-8," +
                ["Timestamp,光强,加速度X,加速度Y,加速度Z,角速度X,角速度Y,角速度Z,经度,纬度"]
                .concat(dataHistory.map(d => [
                    d.Timestamp, d.Light,
                    ...(d.Accelerometer || [null, null, null]),
                    ...(d.Gyroscope || [null, null, null]),
                    ...(d.Location || [null, null])
                ].join(",")))
                .join("\n");
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = "sensor_data.csv";
            link.click();
        });
    </script>
</body>
</html>